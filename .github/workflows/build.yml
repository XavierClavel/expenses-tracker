name: Docker Image CI

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Extract project version
        id: version
        run: |
          VERSION=$(./gradlew -q printVersion)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Detected version: $VERSION"

      - name: Gradle build
        run: ./gradlew clean build --no-daemon

      - name: List subprojects
        run: ./gradlew projects

      - name: Build and push images
        run: |
          for project in $(find . -name Dockerfile -exec dirname {} \;); do
            project=$(basename $project)
            echo "Building Docker image for $project..."
            docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/expenses-tracker-$project:${{ env.VERSION }} $project
            docker push ${{ secrets.DOCKERHUB_USERNAME }}/expenses-tracker-$project:${{ env.VERSION }}
            docker tag ${{ secrets.DOCKERHUB_USERNAME }}/expenses-tracker-$project:${{ env.VERSION }} ${{ secrets.DOCKERHUB_USERNAME }}/expenses-tracker-$project:latest
            docker push ${{ secrets.DOCKERHUB_USERNAME }}/expenses-tracker-$project:latest
          done

      - name: Create tag if it does not exist
        run: |
          if git rev-parse "v${{ env.VERSION }}" >/dev/null 2>&1; then
            echo "Tag v${{ env.VERSION }} already exists. Skipping."
          else
            git tag v${{ env.VERSION }}
            git push origin v${{ env.VERSION }}
          fi

      - name: Create GitHub Release if it does not exist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = `v${process.env.VERSION}`;
            try {
              // Check if release already exists
              await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag
              });
              core.info(`Release ${tag} already exists. Skipping.`);
            } catch (error) {
              if (error.status === 404) {
                core.info(`Creating new release for ${tag}`);
                await github.rest.repos.createRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: tag,
                  name: `Release ${process.env.VERSION}`,
                  body: "Release created automatically by GitHub Actions.",
                  draft: false,
                  prerelease: process.env.prerelease === 'true'
                });
              } else {
                throw error;
              }
            }