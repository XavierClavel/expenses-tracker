name: Expo CI

on:
  workflow_dispatch:

concurrency:
  group: eas-build-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: üèó Setup repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üèó Setup Node
        uses: actions/setup-node@v3
        with:
          cache-dependency-path: frontend/package-lock.json
          node-version: 20
          cache: 'npm'

      - name: üèó Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        run: npm install
        working-directory: frontend

      - name: Extract project version
        id: version
        run: |
          VERSION=$(node -p "require('./frontend/app.json').expo.version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Detected version: $VERSION"
          TAG="app-v$VERSION"
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "Building with tag: $TAG"

      - name: üîç Check if version already built
        id: version-check
        run: |
          if git tag | grep -q "$TAG"; then
            echo "already_built=true" >> $GITHUB_OUTPUT
          else
            echo "already_built=false" >> $GITHUB_OUTPUT
          fi

      - name: üöÄ Build app
        if: steps.version-check.outputs.already_built == 'false'
        run: eas build -p android --profile preview --non-interactive
        working-directory: frontend

      - name: üè∑Ô∏è Create tag
        if: steps.version-check.outputs.already_built == 'false'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ env.TAG }}
          git push origin ${{ env.TAG }}

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Check if release already exists
              await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: process.env.TAG
              });
              core.info(`Release ${process.env.TAG} already exists. Skipping.`);
            } catch (error) {
              if (error.status === 404) {
                core.info(`Creating new release for ${process.env.TAG}`);
                await github.rest.repos.createRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: process.env.TAG,
                  name: `Release ${process.env.TAG}`,
                  body: "Release created automatically by GitHub Actions.",
                  draft: false,
                  prerelease: process.env.prerelease === 'true'
                });
              } else {
                throw error;
              }
            }